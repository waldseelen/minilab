{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Avatar Ã¶nizleme container */
    .avatar-preview {
        position: relative;
        width: 280px;
        height: 280px;
        margin: 0 auto;
    }

    .avatar-layer {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    /* SeÃ§im animasyonu */
    @keyframes item-select {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .item-selected {
        animation: item-select 0.3s ease;
    }

    /* ParÄ±ltÄ± efekti */
    @keyframes sparkle {
        0%, 100% { opacity: 0; transform: scale(0.8) rotate(0deg); }
        50% { opacity: 1; transform: scale(1) rotate(180deg); }
    }

    .sparkle {
        animation: sparkle 2s ease-in-out infinite;
    }

    /* Avatar renk seÃ§enekleri */
    .color-option {
        transition: all 0.2s ease;
    }

    .color-option:hover {
        transform: scale(1.2);
    }

    .color-option.selected {
        ring: 3px solid currentColor;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8" x-data="avatarCustomizer()">

    <!-- BaÅŸlÄ±k -->
    <div class="text-center mb-8">
        <div class="inline-flex items-center gap-4 bg-gradient-to-r from-minilab-blue-400 to-minilab-purple text-white px-8 py-4 rounded-full shadow-2xl">
            <span class="text-5xl animate-wiggle">ğŸ¨</span>
            <div class="text-left">
                <h1 class="font-display text-3xl">Avatar Ã–zelleÅŸtir</h1>
                <p class="text-white/80">AvatarÄ±nÄ± dilediÄŸin gibi sÃ¼sle!</p>
            </div>
            <button @click="Alpine.store('app').speak('AvatarÄ±nÄ± Ã¶zelleÅŸtir! KÄ±yafetler, aksesuarlar ve arka planlar arasÄ±ndan seÃ§.')"
                    class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full flex items-center gap-2 transition-all hover:scale-105 ml-4">
                ğŸ”Š Dinle
            </button>
        </div>
    </div>

    <!-- YÄ±ldÄ±z Tozu Bakiyesi -->
    <div class="text-center mb-6">
        <span class="inline-flex items-center gap-2 bg-minilab-yellow/20 px-6 py-2 rounded-full">
            <span class="text-2xl">â­</span>
            <span class="font-bold text-minilab-orange-500">{{ star_dust }}</span>
            <span class="text-gray-500">YÄ±ldÄ±z Tozu</span>
        </span>
    </div>

    <div class="grid md:grid-cols-2 gap-8">

        <!-- Avatar Ã–nizleme -->
        <div class="card-cute text-center">
            <h2 class="font-display text-xl text-minilab-blue-600 mb-6">ğŸ‘¤ AvatarÄ±n</h2>

            <!-- Avatar Preview Canvas -->
            <div class="avatar-preview mx-auto relative">
                <!-- Arka Plan KatmanÄ± -->
                <div class="avatar-layer rounded-full overflow-hidden"
                     :class="selectedItems.background?.bgClass || 'bg-gradient-to-br from-minilab-blue-100 to-minilab-purple/20'">
                </div>

                <!-- Karakter GÃ¶vdesi -->
                <div class="avatar-layer z-10">
                    <span class="text-[120px]" x-text="selectedItems.body?.icon || 'ğŸ‘¶'">ğŸ‘¶</span>
                </div>

                <!-- Aksesuar (Åapka/GÃ¶zlÃ¼k) -->
                <div class="avatar-layer z-20" x-show="selectedItems.accessory">
                    <span class="text-6xl absolute top-4" x-text="selectedItems.accessory?.icon"></span>
                </div>

                <!-- Evcil Hayvan -->
                <div class="avatar-layer z-30" x-show="selectedItems.pet">
                    <span class="text-5xl absolute bottom-4 right-4" x-text="selectedItems.pet?.icon"></span>
                </div>

                <!-- ParÄ±ltÄ±lar -->
                <div class="absolute -top-2 -right-2 text-2xl sparkle" style="animation-delay: 0s;">âœ¨</div>
                <div class="absolute top-1/4 -left-2 text-xl sparkle" style="animation-delay: 0.5s;">â­</div>
                <div class="absolute -bottom-2 right-1/4 text-lg sparkle" style="animation-delay: 1s;">ğŸ’«</div>
            </div>

            <!-- Avatar Renk SeÃ§imi -->
            <div class="mt-6">
                <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-3">ğŸ¨ Arka Plan Rengi</h4>
                <div class="flex justify-center gap-3 flex-wrap">
                    <button @click="selectColor('blue')"
                            :class="avatarColor === 'blue' ? 'ring-4 ring-blue-300 scale-110' : ''"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-200 to-blue-400 color-option"></button>
                    <button @click="selectColor('purple')"
                            :class="avatarColor === 'purple' ? 'ring-4 ring-purple-300 scale-110' : ''"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-200 to-purple-400 color-option"></button>
                    <button @click="selectColor('pink')"
                            :class="avatarColor === 'pink' ? 'ring-4 ring-pink-300 scale-110' : ''"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-200 to-pink-400 color-option"></button>
                    <button @click="selectColor('green')"
                            :class="avatarColor === 'green' ? 'ring-4 ring-green-300 scale-110' : ''"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-green-200 to-green-400 color-option"></button>
                    <button @click="selectColor('yellow')"
                            :class="avatarColor === 'yellow' ? 'ring-4 ring-yellow-300 scale-110' : ''"
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-200 to-orange-300 color-option"></button>
                </div>
            </div>

            <!-- Aksiyon ButonlarÄ± -->
            <div class="mt-6 flex gap-3 justify-center">
                <button @click="saveAvatar()"
                        :disabled="isSaving"
                        class="btn-primary flex items-center gap-2">
                    <span x-show="!isSaving">ğŸ’¾ Kaydet</span>
                    <span x-show="isSaving" class="flex items-center gap-2">
                        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        Kaydediliyor...
                    </span>
                </button>
                <button @click="resetAvatar()" class="btn-secondary">
                    ğŸ”„ SÄ±fÄ±rla
                </button>
            </div>

            <!-- Kaydetme MesajÄ± -->
            <div x-show="saveMessage"
                 x-transition
                 class="mt-4 px-4 py-2 rounded-full text-sm font-bold"
                 :class="saveSuccess ? 'bg-minilab-green/20 text-minilab-green' : 'bg-red-100 text-red-600'">
                <span x-text="saveMessage"></span>
            </div>
        </div>

        <!-- Ã–zelleÅŸtirme SeÃ§enekleri -->
        <div class="space-y-6">

            <!-- GÃ¶vde/KÄ±yafet -->
            <div class="card-cute">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    ğŸ‘• KÄ±yafetler
                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full"
                          x-text="itemsByType.body?.length || 0"></span>
                </h3>
                <div class="flex gap-3 flex-wrap">
                    <!-- VarsayÄ±lan -->
                    <button @click="selectItem('body', {id: 0, icon: 'ğŸ‘¶', name: 'VarsayÄ±lan'})"
                            :class="selectedItems.body?.id === 0 || !selectedItems.body ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                            class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform">
                        ğŸ‘¶
                    </button>
                    <template x-for="item in itemsByType.body || []" :key="item.id">
                        <button @click="selectItem('body', item)"
                                :class="selectedItems.body?.id === item.id ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                                :title="item.name"
                                class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform">
                            <span x-text="item.icon"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Aksesuarlar -->
            <div class="card-cute">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    ğŸ’ Aksesuarlar
                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full"
                          x-text="itemsByType.accessory?.length || 0"></span>
                </h3>
                <div class="flex gap-3 flex-wrap">
                    <!-- HiÃ§biri -->
                    <button @click="selectItem('accessory', null)"
                            :class="!selectedItems.accessory ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                            class="w-14 h-14 rounded-xl flex items-center justify-center text-lg hover:scale-110 transition-transform text-gray-400">
                        âœ•
                    </button>
                    <template x-for="item in itemsByType.accessory || []" :key="item.id">
                        <button @click="selectItem('accessory', item)"
                                :class="selectedItems.accessory?.id === item.id ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                                :title="item.name"
                                class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform">
                            <span x-text="item.icon"></span>
                        </button>
                    </template>
                </div>
                <p x-show="!itemsByType.accessory?.length" class="text-gray-400 text-sm mt-2">
                    ğŸ›’ MaÄŸazadan aksesuar satÄ±n alabilirsin!
                </p>
            </div>

            <!-- Arka Planlar -->
            <div class="card-cute">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    ğŸŒˆ Arka Planlar
                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full"
                          x-text="itemsByType.background?.length || 0"></span>
                </h3>
                <div class="flex gap-3 flex-wrap">
                    <!-- VarsayÄ±lan -->
                    <button @click="selectItem('background', {id: 0, bgClass: 'bg-gradient-to-br from-minilab-blue-100 to-minilab-purple/20', name: 'VarsayÄ±lan'})"
                            :class="!selectedItems.background || selectedItems.background?.id === 0 ? 'ring-2 ring-minilab-purple scale-110' : ''"
                            class="w-14 h-14 bg-gradient-to-br from-minilab-blue-200 to-minilab-purple/30 rounded-xl hover:scale-110 transition-transform"></button>
                    <template x-for="item in itemsByType.background || []" :key="item.id">
                        <button @click="selectItem('background', item)"
                                :class="selectedItems.background?.id === item.id ? 'ring-2 ring-minilab-purple scale-110' : ''"
                                :title="item.name"
                                class="w-14 h-14 rounded-xl hover:scale-110 transition-transform flex items-center justify-center text-2xl bg-gradient-to-br from-purple-200 to-pink-200">
                            <span x-text="item.icon"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Evcil Hayvanlar -->
            <div class="card-cute">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    ğŸ¾ Evcil Hayvanlar
                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full"
                          x-text="itemsByType.pet?.length || 0"></span>
                </h3>
                <div class="flex gap-3 flex-wrap">
                    <!-- HiÃ§biri -->
                    <button @click="selectItem('pet', null)"
                            :class="!selectedItems.pet ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                            class="w-14 h-14 rounded-xl flex items-center justify-center text-lg hover:scale-110 transition-transform text-gray-400">
                        âœ•
                    </button>
                    <template x-for="item in itemsByType.pet || []" :key="item.id">
                        <button @click="selectItem('pet', item)"
                                :class="selectedItems.pet?.id === item.id ? 'ring-2 ring-minilab-purple bg-minilab-purple/10' : 'bg-gray-100 dark:bg-gray-700'"
                                :title="item.name"
                                class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform">
                            <span x-text="item.icon"></span>
                        </button>
                    </template>
                </div>
                <p x-show="!itemsByType.pet?.length" class="text-gray-400 text-sm mt-2">
                    ğŸ›’ MaÄŸazadan evcil hayvan satÄ±n alabilirsin!
                </p>
            </div>

            <!-- MaÄŸaza Linki -->
            <div class="text-center">
                <a href="{% url 'gamification:shop' %}"
                   class="inline-flex items-center gap-2 bg-gradient-to-r from-minilab-purple to-minilab-pink text-white px-6 py-3 rounded-full font-bold hover:shadow-lg hover:scale-105 transition-all">
                    ğŸ›ï¸ MaÄŸazaya Git
                </a>
                <p class="text-gray-500 text-sm mt-2">
                    Daha fazla Ã¶ÄŸe iÃ§in maÄŸazayÄ± ziyaret et!
                </p>
            </div>
        </div>
    </div>

</div>

<script>
function avatarCustomizer() {
    return {
        // VeritabanÄ±ndan gelen veriler
        itemsByType: {{ items_json|safe }},
        equippedItems: {{ equipped_json|safe }},

        // SeÃ§ili Ã¶ÄŸeler
        selectedItems: {
            body: null,
            accessory: null,
            background: null,
            pet: null
        },

        avatarColor: '{{ avatar_color|default:"blue" }}',
        isSaving: false,
        saveMessage: '',
        saveSuccess: false,

        init() {
            // KuÅŸanÄ±lmÄ±ÅŸ Ã¶ÄŸeleri yÃ¼kle
            this.selectedItems = { ...this.equippedItems };

            // VarsayÄ±lan body
            if (!this.selectedItems.body) {
                this.selectedItems.body = { id: 0, icon: 'ğŸ‘¶', name: 'VarsayÄ±lan' };
            }
        },

        selectItem(type, item) {
            this.selectedItems[type] = item;

            // Sesli geri bildirim
            if (item) {
                Alpine.store('app').playSound('click');
            }
        },

        selectColor(color) {
            this.avatarColor = color;
            Alpine.store('app').playSound('click');
        },

        async saveAvatar() {
            this.isSaving = true;
            this.saveMessage = '';

            try {
                // Avatar ayarlarÄ±nÄ± kaydet
                const response = await fetch("{% url 'gamification:save_avatar' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        avatar_body: this.selectedItems.body?.icon || 'ğŸ‘¶',
                        avatar_color: this.avatarColor,
                        avatar_accessory: this.selectedItems.accessory?.icon || '',
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // KuÅŸanma durumlarÄ±nÄ± gÃ¼ncelle
                    for (const [type, item] of Object.entries(this.selectedItems)) {
                        if (item && item.id) {
                            await this.equipItem(item.id, true);
                        }
                    }

                    this.saveMessage = 'âœ… Avatar kaydedildi!';
                    this.saveSuccess = true;
                    Alpine.store('app').speak('Avatar kaydedildi!');
                    Alpine.store('app').playSound('success');
                } else {
                    this.saveMessage = data.error || 'Bir hata oluÅŸtu';
                    this.saveSuccess = false;
                }
            } catch (error) {
                console.error('Kaydetme hatasÄ±:', error);
                this.saveMessage = 'BaÄŸlantÄ± hatasÄ±';
                this.saveSuccess = false;
            } finally {
                this.isSaving = false;
                setTimeout(() => this.saveMessage = '', 3000);
            }
        },

        async equipItem(itemId, equip) {
            try {
                await fetch("{% url 'gamification:equip_item' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        equip: equip
                    })
                });
            } catch (error) {
                console.error('KuÅŸanma hatasÄ±:', error);
            }
        },

        resetAvatar() {
            this.selectedItems = {
                body: { id: 0, icon: 'ğŸ‘¶', name: 'VarsayÄ±lan' },
                accessory: null,
                background: null,
                pet: null
            };
            this.avatarColor = 'blue';
            Alpine.store('app').speak('Avatar sÄ±fÄ±rlandÄ±');
        }
    }
}
</script>
{% endblock %}
