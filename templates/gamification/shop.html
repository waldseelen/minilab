{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* ÃœrÃ¼n parlama efekti */
    @keyframes item-shine {
        0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
        70% { box-shadow: 0 0 0 15px rgba(139, 92, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
    }

    .item-new {
        animation: item-shine 2s ease-out infinite;
    }

    /* Nadir Ã¼rÃ¼n efekti */
    .item-rare {
        background: linear-gradient(135deg, #f3e8ff 0%, #ddd6fe 50%, #f3e8ff 100%);
    }

    .item-epic {
        background: linear-gradient(135deg, #fdf4ff 0%, #f5d0fe 50%, #fdf4ff 100%);
    }

    .item-legendary {
        background: linear-gradient(135deg, #fefce8 0%, #fde047 50%, #fefce8 100%);
        animation: legendary-glow 2s ease-in-out infinite;
    }

    @keyframes legendary-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.3); }
        50% { box-shadow: 0 0 40px rgba(250, 204, 21, 0.6); }
    }

    /* SatÄ±n alma baÅŸarÄ± animasyonu */
    @keyframes purchase-success {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .purchase-success {
        animation: purchase-success 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" x-data="shopPage()">

    <!-- BaÅŸlÄ±k -->
    <div class="text-center mb-8">
        <div class="inline-flex items-center gap-4 bg-gradient-to-r from-minilab-purple to-minilab-pink text-white px-8 py-4 rounded-full shadow-2xl">
            <span class="text-5xl animate-wiggle">ğŸ›ï¸</span>
            <div class="text-left">
                <h1 class="font-display text-3xl">Avatar MaÄŸazasÄ±</h1>
                <p class="text-white/80">YÄ±ldÄ±z tozlarÄ±nla avatarÄ±nÄ± Ã¶zelleÅŸtir!</p>
            </div>
            <button @click="Alpine.store('app').speak('Avatar maÄŸazasÄ±na hoÅŸ geldin! YÄ±ldÄ±z tozlarÄ±nla avatarÄ±na yeni aksesuarlar ve kÄ±yafetler alabilirsin.')"
                    class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full flex items-center gap-2 transition-all hover:scale-105 ml-4">
                ğŸ”Š Dinle
            </button>
        </div>
    </div>

    <!-- YÄ±ldÄ±z Tozu Bakiyesi -->
    <div class="card-cute mb-8 bg-gradient-to-r from-minilab-yellow to-minilab-orange-400 text-white">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <p class="text-white/80">YÄ±ldÄ±z Tozu Bakiyen</p>
                <p class="font-display text-4xl">â­ <span x-text="starDust">{{ star_dust }}</span></p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'gamification:customize_avatar' %}" class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-full font-bold transition-all hover:scale-105">
                    ğŸ¨ AvatarÄ±m
                </a>
                <a href="{% url 'gamification:surprise_egg' %}" class="bg-white text-minilab-orange-500 px-6 py-3 rounded-full font-bold hover:scale-105 transition-all">
                    ğŸ¥š SÃ¼rpriz Yumurta
                </a>
            </div>
        </div>
    </div>

    <!-- Kategoriler -->
    <div class="flex gap-3 mb-8 overflow-x-auto pb-2">
        <button @click="filterCategory('all')"
                :class="activeCategory === 'all' ? 'bg-minilab-purple text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-minilab-purple/20'"
                class="px-6 py-2 rounded-full font-bold whitespace-nowrap transition-colors">
            ğŸŒŸ TÃ¼mÃ¼ (<span x-text="items.length"></span>)
        </button>
        <button @click="filterCategory('body')"
                :class="activeCategory === 'body' ? 'bg-minilab-purple text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-minilab-purple/20'"
                class="px-6 py-2 rounded-full font-bold whitespace-nowrap transition-colors">
            ğŸ‘• KÄ±yafetler (<span x-text="items.filter(i => i.category === 'body').length"></span>)
        </button>
        <button @click="filterCategory('accessory')"
                :class="activeCategory === 'accessory' ? 'bg-minilab-purple text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-minilab-purple/20'"
                class="px-6 py-2 rounded-full font-bold whitespace-nowrap transition-colors">
            ğŸ’ Aksesuarlar (<span x-text="items.filter(i => i.category === 'accessory').length"></span>)
        </button>
        <button @click="filterCategory('background')"
                :class="activeCategory === 'background' ? 'bg-minilab-purple text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-minilab-purple/20'"
                class="px-6 py-2 rounded-full font-bold whitespace-nowrap transition-colors">
            ğŸŒˆ Arka Planlar (<span x-text="items.filter(i => i.category === 'background').length"></span>)
        </button>
        <button @click="filterCategory('pet')"
                :class="activeCategory === 'pet' ? 'bg-minilab-purple text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-minilab-purple/20'"
                class="px-6 py-2 rounded-full font-bold whitespace-nowrap transition-colors">
            ğŸ¾ Evcil Hayvanlar (<span x-text="items.filter(i => i.category === 'pet').length"></span>)
        </button>
    </div>

    <!-- MaÄŸaza ÃœrÃ¼nleri -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <template x-for="item in filteredItems" :key="item.id">
            <div class="card-cute text-center p-6 group hover:scale-105 transition-all cursor-pointer relative"
                 :class="{
                     'item-rare': item.rarity === 'rare',
                     'item-epic': item.rarity === 'epic',
                     'item-legendary': item.rarity === 'legendary',
                     'opacity-60 grayscale': item.owned,
                     'purchase-success': justPurchased === item.id
                 }"
                 @click="!item.owned && openPurchaseModal(item)">

                <!-- Nadir Badge -->
                <div x-show="item.rarity === 'legendary'"
                     class="absolute -top-2 -right-2 bg-minilab-yellow text-white text-xs px-2 py-1 rounded-full font-bold animate-bounce z-10">
                    âœ¨ Efsanevi
                </div>
                <div x-show="item.rarity === 'epic'"
                     class="absolute -top-2 -right-2 bg-minilab-pink text-white text-xs px-2 py-1 rounded-full font-bold z-10">
                    ğŸ’ Epik
                </div>
                <div x-show="item.rarity === 'rare'"
                     class="absolute -top-2 -right-2 bg-minilab-purple text-white text-xs px-2 py-1 rounded-full font-bold z-10">
                    â­ Nadir
                </div>

                <!-- Ãœcretsiz Badge -->
                <div x-show="item.is_free && !item.owned"
                     class="absolute top-2 left-2 bg-minilab-green text-white text-xs px-2 py-1 rounded-full font-bold z-10">
                    ğŸ Ãœcretsiz
                </div>

                <!-- Sahip olunuyor badge -->
                <div x-show="item.owned"
                     class="absolute top-2 left-2 bg-minilab-green text-white text-xs px-2 py-1 rounded-full font-bold z-10">
                    âœ“ Sahip
                </div>

                <div class="text-6xl mb-4 group-hover:animate-bounce" x-text="item.icon"></div>
                <h3 class="font-bold text-lg mb-2" x-text="item.name"></h3>

                <div class="flex items-center justify-center gap-1 mb-4" x-show="!item.is_free">
                    <span class="text-minilab-yellow">â­</span>
                    <span class="font-bold" x-text="item.price"></span>
                </div>
                <div class="mb-4" x-show="item.is_free">
                    <span class="text-minilab-green font-bold">Ãœcretsiz!</span>
                </div>

                <button x-show="!item.owned"
                        class="bg-gradient-to-r from-minilab-purple to-minilab-pink text-white w-full py-2 rounded-full font-bold hover:shadow-lg transition-all"
                        :class="{ 'opacity-50 cursor-not-allowed': !item.is_free && starDust < item.price }">
                    <span x-show="item.is_free || starDust >= item.price">SatÄ±n Al</span>
                    <span x-show="!item.is_free && starDust < item.price">Yetersiz â­</span>
                </button>
                <button x-show="item.owned"
                        class="bg-minilab-green/20 text-minilab-green w-full py-2 rounded-full font-bold cursor-default">
                    âœ“ AlÄ±ndÄ±
                </button>
            </div>
        </template>

        <!-- BoÅŸ Durum -->
        <template x-if="filteredItems.length === 0">
            <div class="col-span-full text-center py-12">
                <span class="text-6xl block mb-4">ğŸª</span>
                <p class="text-gray-500 dark:text-gray-400">Bu kategoride henÃ¼z Ã¼rÃ¼n yok.</p>
            </div>
        </template>
    </div>

    <!-- SatÄ±n Alma Modal -->
    <div x-show="showModal"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
         @click.self="showModal = false"
         @keydown.escape.window="showModal = false">

        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full shadow-2xl"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-90"
             x-transition:enter-end="opacity-100 scale-100">

            <div class="text-center">
                <div class="text-8xl mb-4 animate-bounce" x-text="selectedItem?.icon">ğŸ</div>
                <h3 class="font-display text-2xl text-minilab-purple mb-2" x-text="selectedItem?.name">ÃœrÃ¼n</h3>
                <p class="text-gray-500 mb-6">Bu Ã¼rÃ¼nÃ¼ satÄ±n almak istiyor musun?</p>

                <div class="bg-minilab-yellow/20 rounded-2xl p-4 mb-6" x-show="!selectedItem?.is_free">
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-3xl">â­</span>
                        <span class="font-display text-3xl text-minilab-orange-500" x-text="selectedItem?.price">0</span>
                        <span class="text-gray-500">YÄ±ldÄ±z Tozu</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        Kalan bakiye: <strong x-text="starDust - (selectedItem?.price || 0)"></strong> â­
                    </p>
                </div>

                <div class="bg-minilab-green/20 rounded-2xl p-4 mb-6" x-show="selectedItem?.is_free">
                    <p class="text-lg text-minilab-green font-bold">ğŸ Bu Ã¼rÃ¼n Ã¼cretsiz!</p>
                </div>

                <!-- Hata MesajÄ± -->
                <div x-show="purchaseError"
                     class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl p-4 mb-4">
                    <span x-text="purchaseError"></span>
                </div>

                <div class="flex gap-3">
                    <button @click="showModal = false"
                            class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-3 rounded-full font-bold hover:bg-gray-200 transition-colors">
                        Ä°ptal
                    </button>
                    <button @click="purchaseItem()"
                            :disabled="isProcessing"
                            class="flex-1 bg-gradient-to-r from-minilab-purple to-minilab-pink text-white py-3 rounded-full font-bold hover:shadow-lg transition-all disabled:opacity-50">
                        <span x-show="!isProcessing">ğŸ›’ SatÄ±n Al</span>
                        <span x-show="isProcessing" class="flex items-center justify-center gap-2">
                            <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Ä°ÅŸleniyor...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BaÅŸarÄ± MesajÄ± -->
    <div x-show="purchaseSuccess"
         x-transition
         class="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-minilab-green text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
        <span class="text-3xl">ğŸ‰</span>
        <span class="font-bold" x-text="successMessage">SatÄ±n alma baÅŸarÄ±lÄ±!</span>
    </div>

</div>

<script>
function shopPage() {
    return {
        starDust: {{ star_dust }},
        activeCategory: 'all',
        showModal: false,
        selectedItem: null,
        purchaseSuccess: false,
        purchaseError: '',
        successMessage: '',
        isProcessing: false,
        justPurchased: null,

        // VeritabanÄ±ndan gelen Ã¼rÃ¼nler
        items: {{ items_json|safe }},

        get filteredItems() {
            if (this.activeCategory === 'all') return this.items;
            return this.items.filter(item => item.category === this.activeCategory);
        },

        filterCategory(category) {
            this.activeCategory = category;
        },

        openPurchaseModal(item) {
            if (!item.is_free && this.starDust < item.price) {
                Alpine.store('app').speak('Yeterli yÄ±ldÄ±z tozun yok. Daha fazla deney yaparak yÄ±ldÄ±z tozu kazanabilirsin!');
                return;
            }
            this.selectedItem = item;
            this.purchaseError = '';
            this.showModal = true;
        },

        async purchaseItem() {
            if (!this.selectedItem) return;
            if (!this.selectedItem.is_free && this.starDust < this.selectedItem.price) return;

            this.isProcessing = true;
            this.purchaseError = '';

            try {
                const response = await fetch(`{% url 'gamification:purchase_item' 0 %}`.replace('0', this.selectedItem.id), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (data.success) {
                    // Bakiyeyi gÃ¼ncelle
                    this.starDust = data.new_balance;

                    // ÃœrÃ¼nÃ¼ sahip olunan olarak iÅŸaretle
                    const item = this.items.find(i => i.id === this.selectedItem.id);
                    if (item) item.owned = true;

                    // BaÅŸarÄ± animasyonu
                    this.justPurchased = this.selectedItem.id;
                    setTimeout(() => this.justPurchased = null, 500);

                    // BaÅŸarÄ± mesajÄ±
                    this.successMessage = data.message;
                    this.purchaseSuccess = true;

                    // Sesli geri bildirim
                    Alpine.store('app').speak(`Tebrikler! ${this.selectedItem.name} artÄ±k senin!`);
                    Alpine.store('app').playSound('success');

                    // Modal'Ä± kapat
                    this.showModal = false;
                    setTimeout(() => this.purchaseSuccess = false, 3000);
                } else {
                    this.purchaseError = data.error || 'Bir hata oluÅŸtu';
                    if (data.already_owned) {
                        // Yerel durumu gÃ¼ncelle
                        const item = this.items.find(i => i.id === this.selectedItem.id);
                        if (item) item.owned = true;
                    }
                }
            } catch (error) {
                console.error('SatÄ±n alma hatasÄ±:', error);
                this.purchaseError = 'BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar dene.';
            } finally {
                this.isProcessing = false;
            }
        }
    }
}
</script>
{% endblock %}
