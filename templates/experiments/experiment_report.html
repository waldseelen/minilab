{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* Konfeti animasyonu */
    @keyframes confetti-fall {
        0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        top: 0;
        animation: confetti-fall 4s linear forwards;
        z-index: 100;
    }

    /* YÄ±ldÄ±z patlamasÄ± */
    @keyframes star-burst {
        0% { transform: scale(0) rotate(0deg); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: scale(1.5) rotate(180deg); opacity: 0; }
    }

    .star-burst {
        animation: star-burst 1.5s ease-out forwards;
    }

    /* Puan sayacÄ± */
    @keyframes count-up {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
    }

    .points-animate {
        animation: count-up 0.5s ease-out forwards;
    }

    /* Rozet parlamasÄ± */
    @keyframes badge-shine {
        0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(251, 191, 36, 0); }
        100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
    }

    .badge-glow {
        animation: badge-shine 1.5s ease-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen relative overflow-hidden" x-data="reportPage()">

    <!-- Konfeti Container -->
    <div id="confetti-container" class="pointer-events-none"></div>

    <div class="max-w-4xl mx-auto px-4 py-8">

        <!-- BaÅŸarÄ± KartÄ± -->
        <div class="bg-gradient-to-r from-minilab-green via-minilab-blue-400 to-minilab-purple rounded-[2rem] p-8 mb-8 text-white shadow-2xl text-center relative overflow-hidden">

            <!-- Dekoratif yÄ±ldÄ±zlar -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden">
                <span class="absolute text-4xl star-burst" style="top: 10%; left: 10%; animation-delay: 0.2s;">â­</span>
                <span class="absolute text-3xl star-burst" style="top: 20%; right: 15%; animation-delay: 0.4s;">âœ¨</span>
                <span class="absolute text-5xl star-burst" style="bottom: 15%; left: 20%; animation-delay: 0.6s;">ğŸŒŸ</span>
                <span class="absolute text-4xl star-burst" style="bottom: 25%; right: 10%; animation-delay: 0.8s;">ğŸ’«</span>
            </div>

            <div class="relative z-10">
                <div class="text-8xl mb-4 animate-bounce-slow">ğŸ‰</div>
                <h1 class="font-display text-4xl mb-2">Tebrikler!</h1>
                <p class="text-white/90 text-xl mb-4">{{ experiment.title }} deneyini tamamladÄ±n!</p>

                <!-- Puan -->
                {% if progress %}
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-8 py-4 inline-flex items-center gap-4 mt-4">
                    <div class="text-center">
                        <span class="text-4xl font-display points-animate">+{{ progress.score }}</span>
                        <p class="text-white/80 text-sm">YÄ±ldÄ±z Tozu</p>
                    </div>
                    <div class="w-px h-12 bg-white/30"></div>
                    <div class="text-center">
                        <span class="text-4xl">â­</span>
                        <p class="text-white/80 text-sm">{{ child.star_dust|default:0 }} Toplam</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Yeni Rozetler -->
        {% if recent_badges %}
        <div class="card-cute mb-8 text-center">
            <h2 class="font-display text-2xl text-minilab-yellow mb-6">ğŸ† Yeni Rozet KazandÄ±n!</h2>
            <div class="flex justify-center gap-6 flex-wrap">
                {% for ub in recent_badges %}
                <div class="bg-gradient-to-b from-minilab-yellow/20 to-minilab-orange-400/20 rounded-2xl p-6 badge-glow">
                    <div class="text-6xl mb-2">{{ ub.badge.icon }}</div>
                    <p class="font-bold text-minilab-orange-500">{{ ub.badge.name }}</p>
                    <p class="text-gray-500 text-sm">{{ ub.badge.description }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- BugÃ¼n Neler Ã–ÄŸrendin? -->
        <div class="card-cute mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="font-display text-2xl text-minilab-blue-600">
                    ğŸ“š BugÃ¼n Neler Ã–ÄŸrendin?
                </h2>
                <button @click="Alpine.store('app').speak('BugÃ¼n {{ experiment.title }} deneyinde ÅŸunlarÄ± Ã¶ÄŸrendin: {% for obj in learning_objectives %}{{ obj }}. {% endfor %}')"
                        class="bg-minilab-blue-100 hover:bg-minilab-blue-200 text-minilab-blue-600 px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 transition-all hover:scale-105">
                    ğŸ”Š Dinle
                </button>
            </div>

            {% if learning_objectives %}
            <ul class="space-y-3">
                {% for objective in learning_objectives %}
                <li class="flex items-start gap-3 bg-minilab-blue-50 dark:bg-gray-700 rounded-xl p-4">
                    <span class="text-2xl">âœ…</span>
                    <span class="text-gray-700 dark:text-gray-200">{{ objective }}</span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500 text-center py-4">
                Bu deneyde {{ experiment.category.name }} alanÄ±nda yeni ÅŸeyler keÅŸfettin! ğŸ”¬
            </p>
            {% endif %}
        </div>

        <!-- Mini Quiz -->
        <div class="card-cute mb-8" x-data="{ currentQuestion: 0, answered: false, correct: null }">
            <h2 class="font-display text-2xl text-minilab-purple mb-6">ğŸ§  HÄ±zlÄ± Soru!</h2>

            {% for q in quiz_questions %}
            <div x-show="currentQuestion === {{ forloop.counter0 }}" class="text-center">
                <p class="text-xl mb-6">{{ q.question }}</p>

                {% if q.type == 'choice' %}
                <div class="flex flex-wrap justify-center gap-3">
                    {% for choice in q.choices %}
                    <button @click="answered = true; correct = '{{ choice }}' === '{{ q.correct }}'"
                            :disabled="answered"
                            :class="{
                                'bg-green-500 text-white': answered && '{{ choice }}' === '{{ q.correct }}',
                                'bg-red-400 text-white': answered && '{{ choice }}' !== '{{ q.correct }}' && correct === false,
                                'bg-white hover:bg-minilab-purple/10': !answered
                            }"
                            class="px-6 py-3 rounded-full border-2 border-minilab-purple/30 font-bold transition-all">
                        {{ choice }}
                    </button>
                    {% endfor %}
                </div>

                <div x-show="answered" x-transition class="mt-6">
                    <p x-show="correct" class="text-green-500 font-bold text-xl">ğŸ‰ DoÄŸru! HarikasÄ±n!</p>
                    <p x-show="!correct" class="text-orange-500 font-bold text-xl">ğŸ’ª YaklaÅŸtÄ±n! DoÄŸru cevap: {{ q.correct }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Ä°lgili Kartlar -->
        {% if learning_cards %}
        <div class="card-cute mb-8">
            <h2 class="font-display text-2xl text-minilab-green mb-6">ğŸƒ HatÄ±rla!</h2>
            <div class="grid md:grid-cols-3 gap-4">
                {% for card in learning_cards %}
                <div class="bg-gradient-to-br from-{{ experiment.category.color }}-50 to-white dark:from-gray-700 dark:to-gray-800 rounded-2xl p-4 text-center">
                    <span class="text-3xl">{{ experiment.category.icon }}</span>
                    <h4 class="font-bold text-{{ experiment.category.color }}-600 mt-2">{{ card.title }}</h4>
                    <p class="text-gray-500 text-sm mt-1">{{ card.front_content|truncatewords:10 }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Ä°statistikler -->
        <div class="card-cute mb-8 bg-gradient-to-r from-minilab-blue-50 to-minilab-purple/10">
            <h2 class="font-display text-2xl text-minilab-blue-600 mb-6">ğŸ“Š Senin Ä°lerlemen</h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-md">
                    <span class="text-3xl">ğŸ”¬</span>
                    <p class="font-display text-2xl text-minilab-blue-600 mt-2">{{ total_experiments_completed }}</p>
                    <p class="text-gray-500 text-sm">Tamamlanan Deney</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-md">
                    <span class="text-3xl">â­</span>
                    <p class="font-display text-2xl text-minilab-yellow mt-2">{{ child.star_dust|default:0 }}</p>
                    <p class="text-gray-500 text-sm">YÄ±ldÄ±z Tozu</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-md">
                    <span class="text-3xl">ğŸ†</span>
                    <p class="font-display text-2xl text-minilab-orange-500 mt-2">{{ child.earned_badges.count|default:0 }}</p>
                    <p class="text-gray-500 text-sm">Rozet</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-md">
                    <span class="text-3xl">ğŸ”¥</span>
                    <p class="font-display text-2xl text-minilab-pink mt-2">{{ child.current_streak|default:1 }}</p>
                    <p class="text-gray-500 text-sm">GÃ¼n Serisi</p>
                </div>
            </div>
        </div>

        <!-- Aksiyon ButonlarÄ± -->
        <div class="flex flex-wrap justify-center gap-4">
            <a href="{% url 'experiments:category_detail' experiment.category.slug %}"
               class="btn-secondary flex items-center gap-2">
                â† {{ experiment.category.name }} Kategorisi
            </a>

            <a href="{% url 'dashboard:child_dashboard' %}"
               class="btn-primary flex items-center gap-2">
                ğŸ  Ana Sayfa
            </a>

            <a href="{% url 'gamification:badges' %}"
               class="bg-minilab-yellow hover:bg-minilab-yellow/80 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                ğŸ† Rozetlerim
            </a>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function reportPage() {
    return {
        init() {
            // Konfeti yaÄŸdÄ±r
            this.createConfetti();

            // Tebrikler sesini Ã§al
            setTimeout(() => {
                Alpine.store('app').speak('Tebrikler! {{ experiment.title }} deneyini baÅŸarÄ±yla tamamladÄ±n!');
            }, 1000);
        },

        createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#FBBF24', '#8B5CF6', '#10B981', '#EC4899', '#3B82F6'];

            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    container.appendChild(confetti);

                    // Temizle
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 50);
            }
        }
    }
}
</script>
{% endblock %}
