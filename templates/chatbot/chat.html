{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8 h-[calc(100vh-12rem)]"
     x-data="miniBotChat()">

    <!-- Sohbet BaÅŸlÄ±ÄŸÄ± -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center gap-3 bg-white dark:bg-gray-800 rounded-full px-6 py-3 shadow-lg">
            <span class="text-4xl animate-wiggle">ğŸ¤–</span>
            <h1 class="font-display text-2xl text-minilab-purple">MiniBot ile Sohbet</h1>

            <!-- TTS Toggle ve Temizle -->
            <div class="flex items-center gap-2 ml-4 border-l pl-4 dark:border-gray-600">
                <button @click="ttsEnabled = !ttsEnabled"
                        class="p-2 rounded-full transition-colors"
                        :class="ttsEnabled ? 'bg-minilab-green text-white' : 'bg-gray-200 dark:bg-gray-700'"
                        title="Sesli Okuma">
                    <span x-show="ttsEnabled">ğŸ”Š</span>
                    <span x-show="!ttsEnabled">ğŸ”‡</span>
                </button>
                <button @click="clearHistory()"
                        class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-red-100 transition-colors"
                        title="Sohbeti Temizle">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    </div>

    <!-- Sohbet AlanÄ± -->
    <div class="card-cute h-[calc(100%-12rem)] flex flex-col">

        <!-- Mesajlar -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages" x-ref="chatContainer">

            <!-- MiniBot KarÅŸÄ±lama -->
            <div class="flex gap-3 animate-fade-in">
                <div class="w-12 h-12 bg-gradient-to-br from-minilab-purple to-purple-600 rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow-lg animate-bounce-slow">
                    ğŸ¤–
                </div>
                <div class="bg-gradient-to-r from-minilab-purple/20 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-md">
                    <p class="text-gray-700 dark:text-gray-200">
                        {{ minibot_greeting|default:"Merhaba! Ben MiniBot! ğŸ‰ Bilim hakkÄ±nda bana her ÅŸeyi sorabilirsin! Merak ettiÄŸin ÅŸeyler neler?" }}
                    </p>
                    <button @click="speak('{{ minibot_greeting|default:'Merhaba! Ben MiniBot! Bilim hakkÄ±nda bana her ÅŸeyi sorabilirsin!' }}')"
                            class="mt-2 text-xs text-minilab-purple hover:underline flex items-center gap-1">
                        ğŸ”Š Dinle
                    </button>
                </div>
            </div>

            {% if messages %}
            <!-- Ã–nceki Mesajlar -->
            {% for msg in messages %}
            <div class="flex gap-3 {% if msg.is_user %}flex-row-reverse{% endif %}">
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow-md
                            {% if msg.is_user %}bg-gradient-to-br from-minilab-blue-400 to-blue-500{% else %}bg-gradient-to-br from-minilab-purple to-purple-600{% endif %}">
                    {% if msg.is_user %}ğŸ‘¶{% else %}ğŸ¤–{% endif %}
                </div>
                <div class="rounded-2xl p-4 max-w-[80%] shadow-md
                            {% if msg.is_user %}bg-gradient-to-r from-minilab-blue-400 to-blue-500 text-white rounded-tr-none{% else %}bg-gradient-to-r from-minilab-purple/20 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-tl-none{% endif %}">
                    <p class="{% if msg.is_user %}text-white{% else %}text-gray-700 dark:text-gray-200{% endif %}">
                        {{ msg.message }}
                    </p>
                    {% if not msg.is_user %}
                    <button onclick="speakText('{{ msg.message|escapejs }}')"
                            class="mt-2 text-xs text-minilab-purple hover:underline flex items-center gap-1">
                        ğŸ”Š Dinle
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Yeni Mesaj Listesi (JavaScript ile eklenen) -->
            <template x-for="(msg, index) in messages" :key="index">
                <div :class="msg.sender === 'user' ? 'flex gap-3 flex-row-reverse' : 'flex gap-3'"
                     class="animate-fade-in-up">

                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow-md"
                         :class="msg.sender === 'user' ? 'bg-gradient-to-br from-minilab-blue-400 to-blue-500' : 'bg-gradient-to-br from-minilab-purple to-purple-600'">
                        <span x-text="msg.sender === 'user' ? 'ğŸ‘¶' : 'ğŸ¤–'"></span>
                    </div>

                    <!-- Mesaj -->
                    <div class="rounded-2xl p-4 max-w-[80%] shadow-md"
                         :class="msg.sender === 'user'
                             ? 'bg-gradient-to-r from-minilab-blue-400 to-blue-500 text-white rounded-tr-none'
                             : 'bg-gradient-to-r from-minilab-purple/20 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-tl-none'">
                        <p :class="msg.sender === 'user' ? 'text-white' : 'text-gray-700 dark:text-gray-200'"
                           x-text="msg.text"></p>

                        <!-- Dinle butonu (sadece bot mesajlarÄ± iÃ§in) -->
                        <button x-show="msg.sender !== 'user'"
                                @click="speak(msg.text)"
                                class="mt-2 text-xs text-minilab-purple hover:underline flex items-center gap-1">
                            ğŸ”Š Dinle
                        </button>
                    </div>
                </div>
            </template>

            <!-- YazÄ±yor GÃ¶stergesi -->
            <div x-show="isTyping" x-transition class="flex gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-minilab-purple to-purple-600 rounded-full flex items-center justify-center text-2xl flex-shrink-0 shadow-lg animate-pulse">
                    ğŸ¤–
                </div>
                <div class="bg-gradient-to-r from-minilab-purple/20 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/20 rounded-2xl rounded-tl-none p-4 shadow-md">
                    <div class="flex gap-1.5">
                        <span class="w-3 h-3 bg-minilab-purple rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                        <span class="w-3 h-3 bg-minilab-purple rounded-full animate-bounce" style="animation-delay: 0.15s;"></span>
                        <span class="w-3 h-3 bg-minilab-purple rounded-full animate-bounce" style="animation-delay: 0.3s;"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">MiniBot dÃ¼ÅŸÃ¼nÃ¼yor...</p>
                </div>
            </div>
        </div>

            <!-- HÄ±zlÄ± Sorular -->
        <div class="p-4 border-t dark:border-gray-700 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-800">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 font-medium">ğŸ’¡ HÄ±zlÄ± Sorular (TÄ±kla ve sor!):</p>
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button @click="sendQuickQuestion('GÃ¶kyÃ¼zÃ¼ neden mavi?')"
                        class="px-4 py-2 bg-gradient-to-r from-blue-100 to-blue-200 dark:from-blue-900/50 dark:to-blue-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸŒˆ GÃ¶kyÃ¼zÃ¼ neden mavi?
                </button>
                <button @click="sendQuickQuestion('Dinozorlar neden yok oldu?')"
                        class="px-4 py-2 bg-gradient-to-r from-green-100 to-green-200 dark:from-green-900/50 dark:to-green-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸ¦• Dinozorlar neden yok oldu?
                </button>
                <button @click="sendQuickQuestion('YÄ±ldÄ±zlar neden parlar?')"
                        class="px-4 py-2 bg-gradient-to-r from-yellow-100 to-yellow-200 dark:from-yellow-900/50 dark:to-yellow-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    â­ YÄ±ldÄ±zlar neden parlar?
                </button>
                <button @click="sendQuickQuestion('Kelebekler nasÄ±l uÃ§ar?')"
                        class="px-4 py-2 bg-gradient-to-r from-pink-100 to-pink-200 dark:from-pink-900/50 dark:to-pink-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸ¦‹ Kelebekler nasÄ±l uÃ§ar?
                </button>
                <button @click="sendQuickQuestion('KarÄ±ncalar ne kadar gÃ¼Ã§lÃ¼?')"
                        class="px-4 py-2 bg-gradient-to-r from-orange-100 to-orange-200 dark:from-orange-900/50 dark:to-orange-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸœ KarÄ±ncalar ne kadar gÃ¼Ã§lÃ¼?
                </button>
                <button @click="sendQuickQuestion('Ay neden ÅŸekil deÄŸiÅŸtirir?')"
                        class="px-4 py-2 bg-gradient-to-r from-purple-100 to-purple-200 dark:from-purple-900/50 dark:to-purple-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸŒ™ Ay neden ÅŸekil deÄŸiÅŸtirir?
                </button>
                <button @click="sendQuickQuestion('Renkler nasÄ±l karÄ±ÅŸÄ±r?')"
                        class="px-4 py-2 bg-gradient-to-r from-red-100 to-red-200 dark:from-red-900/50 dark:to-red-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    ğŸ¨ Renkler nasÄ±l karÄ±ÅŸÄ±r?
                </button>
                <button @click="sendQuickQuestion('Kalp nasÄ±l Ã§alÄ±ÅŸÄ±r?')"
                        class="px-4 py-2 bg-gradient-to-r from-red-100 to-pink-200 dark:from-red-900/50 dark:to-pink-800/50 rounded-full text-sm whitespace-nowrap hover:scale-105 active:scale-95 transition-transform shadow-sm hover:shadow-md">
                    â¤ï¸ Kalp nasÄ±l Ã§alÄ±ÅŸÄ±r?
                </button>
            </div>
        </div>        <!-- Mesaj GÃ¶nderme -->
        <div class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800">
            <form @submit.prevent="sendMessage()" class="flex gap-3">
                <input type="text"
                       x-model="newMessage"
                       placeholder="MiniBot'a bir ÅŸey sor... ğŸ”®"
                       class="flex-1 px-6 py-4 rounded-full border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 focus:border-minilab-purple focus:ring-4 focus:ring-minilab-purple/20 focus:outline-none text-lg transition-all"
                       :disabled="isTyping"
                       maxlength="500">

                <!-- Ses ile Yazma -->
                <button type="button"
                        @click="toggleVoiceInput()"
                        class="w-14 h-14 rounded-full flex items-center justify-center transition-all text-xl shadow-md"
                        :class="isListening
                            ? 'bg-gradient-to-r from-red-500 to-red-600 text-white animate-pulse scale-110'
                            : 'bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 hover:scale-105'"
                        :disabled="isTyping">
                    <span x-show="!isListening">ğŸ¤</span>
                    <span x-show="isListening">â¹ï¸</span>
                </button>

                <!-- GÃ¶nder -->
                <button type="submit"
                        class="w-14 h-14 bg-gradient-to-r from-minilab-purple to-purple-600 text-white rounded-full flex items-center justify-center hover:scale-105 transition-all text-xl shadow-lg disabled:opacity-50 disabled:scale-100"
                        :disabled="!newMessage.trim() || isTyping">
                    ğŸš€
                </button>
            </form>

            <!-- Ses durumu gÃ¶stergesi -->
            <div x-show="isListening" x-transition class="mt-3 text-center">
                <p class="text-sm text-red-500 animate-pulse">ğŸ™ï¸ Dinliyorum... KonuÅŸabilirsin!</p>
                <div class="flex justify-center gap-1 mt-2">
                    <span class="w-1 h-4 bg-red-500 rounded animate-pulse" style="animation-delay: 0s;"></span>
                    <span class="w-1 h-6 bg-red-500 rounded animate-pulse" style="animation-delay: 0.1s;"></span>
                    <span class="w-1 h-8 bg-red-500 rounded animate-pulse" style="animation-delay: 0.2s;"></span>
                    <span class="w-1 h-6 bg-red-500 rounded animate-pulse" style="animation-delay: 0.3s;"></span>
                    <span class="w-1 h-4 bg-red-500 rounded animate-pulse" style="animation-delay: 0.4s;"></span>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fade-in-up 0.4s ease-out forwards;
    }

    .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
    }

    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .animate-bounce-slow {
        animation: bounce 2s infinite;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

<script>
// Global speak function for Django template rendered messages
function speakText(text) {
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'tr-TR';
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        speechSynthesis.speak(utterance);
    }
}

function miniBotChat() {
    return {
        messages: [],
        newMessage: '',
        isTyping: false,
        isListening: false,
        recognition: null,
        ttsEnabled: true,  // VarsayÄ±lan olarak aÃ§Ä±k

        init() {
            // Speech Recognition kurulumu
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'tr-TR';
                this.recognition.continuous = false;
                this.recognition.interimResults = false;

                this.recognition.onresult = (event) => {
                    this.newMessage = event.results[0][0].transcript;
                    this.isListening = false;
                    // Otomatik gÃ¶nder
                    setTimeout(() => this.sendMessage(), 500);
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                };

                this.recognition.onerror = (event) => {
                    console.error('Ses tanÄ±ma hatasÄ±:', event.error);
                    this.isListening = false;
                };
            }

            // Scroll to bottom on init
            this.$nextTick(() => {
                this.scrollToBottom();
            });
        },

        scrollToBottom() {
            const container = this.$refs.chatContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },

        async sendMessage() {
            if (!this.newMessage.trim() || this.isTyping) return;

            const userMessage = this.newMessage.trim();
            this.messages.push({ sender: 'user', text: userMessage });
            this.newMessage = '';
            this.isTyping = true;

            // Scroll to bottom
            this.$nextTick(() => this.scrollToBottom());

            try {
                const response = await fetch("{% url 'chatbot:send_message' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await response.json();

                // Yapay gecikme (daha doÄŸal hissi iÃ§in)
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 700));

                if (data.success) {
                    this.messages.push({ sender: 'bot', text: data.response });

                    // Otomatik sesli okuma (TTS aÃ§Ä±ksa)
                    if (this.ttsEnabled && data.tts_enabled !== false) {
                        this.speak(data.response);
                    }
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('Hata:', error);
                // Fallback yanÄ±t
                const fallbackResponse = "Hmm, bir sorun oldu galiba! ğŸ¤” Tekrar dener misin?";
                this.messages.push({ sender: 'bot', text: fallbackResponse });

                if (this.ttsEnabled) {
                    this.speak(fallbackResponse);
                }
            }

            this.isTyping = false;

            // Scroll to bottom
            this.$nextTick(() => this.scrollToBottom());
        },

        sendQuickQuestion(question) {
            this.newMessage = question;
            this.sendMessage();
        },

        toggleVoiceInput() {
            if (!this.recognition) {
                alert('TarayÄ±cÄ±nÄ±z ses tanÄ±mayÄ± desteklemiyor. Chrome veya Edge kullanmayÄ± deneyin.');
                return;
            }

            if (this.isListening) {
                this.recognition.stop();
            } else {
                this.recognition.start();
                this.isListening = true;
            }
        },

        speak(text) {
            if ('speechSynthesis' in window) {
                // Ã–nceki konuÅŸmayÄ± durdur
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                utterance.rate = 0.9;  // Ã‡ocuklar iÃ§in biraz yavaÅŸ
                utterance.pitch = 1.1; // Biraz yÃ¼ksek ton
                utterance.volume = 1;

                // TÃ¼rkÃ§e ses varsa kullan
                const voices = speechSynthesis.getVoices();
                const turkishVoice = voices.find(v => v.lang.startsWith('tr'));
                if (turkishVoice) {
                    utterance.voice = turkishVoice;
                }

                speechSynthesis.speak(utterance);
            }
        },

        async clearHistory() {
            if (!confirm('Sohbet geÃ§miÅŸini silmek istediÄŸine emin misin? ğŸ—‘ï¸')) return;

            try {
                const response = await fetch("{% url 'chatbot:clear_history' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                });

                if (response.ok) {
                    this.messages = [];
                    // SayfayÄ± yenile (Ã¶nceki mesajlarÄ± da temizle)
                    location.reload();
                }
            } catch (error) {
                console.error('Temizleme hatasÄ±:', error);
            }
        }
    }
}

// TÃ¼rkÃ§e sesler yÃ¼klendiÄŸinde hazÄ±r olsun
if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
</script>
{% endblock %}

{% block minibot %}{% endblock %}
